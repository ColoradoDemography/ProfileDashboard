---
title: " "
output: 
  pdf_document:
    latex_engine: xelatex
mainfont: Arial
fontsize: 12pt
geometry: margin=1in
header-includes:
  - \usepackage{booktabs}
  - \usepackage{array}
  - \usepackage{placeins}
  - \usepackage{float}
  - \newcommand{\bminione}{\begin{minipage}{0.50 \textwidth}}
  - \newcommand{\bminitwo}{\begin{minipage}{0.50 \textwidth}}
  - \newcommand{\emini}{\end{minipage}}
params:
  outChk: NA
  fips: NA
  ctyName: NA
  level: NA
  curACS: NA
  curYr: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
# invalidate cache when the tufte version changes
memory.limit(size=100000)

library(tidyverse, quietly=TRUE)
library(scales, quietly=TRUE)
library(codemogAPI, quietly=TRUE)
library(codemogProfile, quietly=TRUE)
library(knitr, quietly=TRUE)
library(kableExtra, quietly=TRUE)
library(RPostgreSQL, quietly=TRUE)
library(rmarkdown)
library(tinytex)
library(VennDiagram)
library(gridExtra)
library(ProfileDashboard)

#text Functions
baseText<- function(place){
  outText <- paste0("Information for ",place," is compiled by the State Demography Office and the U.S. Census Bureau.")
 return(outText)
}

popCText <- function(place) {
  outText <- paste0("The plots and tables in this section describe the general population characteristics of ",place,".  The bars on the plots show the width of the 90% confidence interval.  Categories where the bars do not overlap are significantly different.")
  return(outText)
}

houseText <- function(place) {
  outText <- paste0("The plots and tables in this section describe the charistics of the housing sector in ",place, ".")
  return(outText)
}


# Creating the conditional display vars
#Basic Stats
if("stats" %in% params$outChk) {
  outStats <- TRUE
} else {
  outStats <- FALSE
}

#Population Forecast
if("popf" %in% params$outChk) {
  outPopf <- TRUE
} else {
  outPopf <- FALSE
}

#Population Characteristics: Age
if("pop" %in% params$outChk) {
  outPop <- TRUE
} else {
  outPop <- FALSE
}

#Population Characteristics: Income, Education and Race
if("popc" %in% params$outChk) {
  outPopC <- TRUE
} else {
  outPopC <- FALSE
}

#Housing
if("housing" %in% params$outChk) {
  outHouse <- TRUE
} else {
  outHouse <- FALSE
}

#Commuting
if("comm" %in% params$outChk) {
  outComm <- TRUE
} else {
  outComm <- FALSE
}

#Employment by Industry
if("emplind" %in% params$outChk) {
  outEmply <- TRUE
} else {
  outEmply <- FALSE
}

#Employment and Demographic Forecast
if("emply" %in% params$outChk) {
  outEmplind <- TRUE
} else {
  outEmplind <- FALSE
}
oYr <- params$curYr
oACS <- params$curACS
placeName <- params$ctyName
level <- params$level


if(nchar(params$fips) == 5) {
  fipsc <- substr(params$fips,3,5)
}

if(nchar(params$fips) == 7) {
  fipsc <- substr(params$fips,3,7)
}
fipsl <- params$fips
fipsN <- as.numeric(fipsc)

```
# Demographic and Economic Profile for `r placeName`

`r if(outStats) '## Basic Statistics'`



\bminione
```{r basetext, out.width=3,  out.height=3, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
    if(outStats) {
      cat(baseText(placeName))
      
#`r colFmt(paste0(placeName," Demographic and Economic Profile"),"dolagreen")`
    } 
```
\emini
\bminitwo
```{r County_Map, fig.width=3, fig.height=3, warning=FALSE,  echo= FALSE, message=FALSE, results='asis'}
if(outStats){
   y <- cp_countymap(substr(fipsl,3,5))
   print(y)
   }

```
\emini

\FloatBarrier

```{r Basic_Table, out.width=6, out.height=4, warning=FALSE,  echo= FALSE, message=FALSE, results='asis'}
if(outStats){
  x <-  statsTable1(cty=fipsl, 
                             place="", 
                             sYr=2010,
                             eYr= oYr,
                             ACS=oACS,
                             oType="latex")
   print(x)
   }

```

\newpage  


`r if(outPopf) '## Population Trends'`

\FloatBarrier

```{r popOutf_tab, out.width=6, out.height=0.5, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 #Population, Migration and Natural Increase
   if(outPopf){  
      # Population Change Table
      popTab <- popTable(cty=fipsc,ctyname=placeName,sYr=1990,eYr=oYr,oType="latex")
      cat(popTab$text)
   }
```      


```{r popOutf_plot, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
   if(outPopf) {
     print(popTab$table)
   }    

```

\FloatBarrier

```{r popOutf_popF,  fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
      #County forecast
    if(outPopf) {
      popf1 <- popForecast(fips=fipsN, ctyname = placeName) 
       popf2 <- county_timeseries(fips=fipsc,endYear=oYr)
       popf3 <- cocPlot(fips=fipsN,ctyname=placeName,lYr=oYr)
       print(popf2$plot)
       print(popf3$plot)
       print(popf1$plot)
    }
```

\newpage

`r if(outPop) '## Population by Age'`

\FloatBarrier

```{r popOut_AgeTab, out.width=6, out.height=2, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 #Population, Migration and Natural Increase
    if(outPop){
      medAge <- medianAgeTab(fips=fipsc, ACS=oACS, ctyname=placeName,oType ="latex")
      cat(medAge$text)
    }
   
```

\FloatBarrier

```{r popOut_MigAge, out.width=6, out.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 #Population, Migration and Natural Increase
    if(outPop){
      print(medAge$table)
    }
   
```

\FloatBarrier

```{r popOut_ageP1, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 #Population, Migration and Natural Increase
   if(outPop){
      # Age Plot
      popa1 <- agePlotPRO(fips=fipsN, ctyname=placeName, yrs=2016)
      print(popa1$plot)

   }
```

\FloatBarrier

```{r popOut_ageP3, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 #Population, Migration and Natural Increase
   if(outPop){
      popa3 <- ageForecastPRO(fips=fipsN,stYr=2010,mYr=2015,eYr=2025)
      print(popa3$plot)
   }
```

\FloatBarrier

```{r popOut_ageP4, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 #Population, Migration and Natural Increase
   if(outPop){
      # Age Plot
     popa4 <- migbyagePRO(fips=fipsN, ctyname = placeName)
      print(popa4$plot)
   }
```  

\newpage

`r if(outPopC) '## Population Characteristics: Income, Education, and Race'`


`r if(outPopC) popCText(placeName)`

\FloatBarrier

```{r popOutC_income, fig.width=6, fig.height=3.75, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outPopC){
    # Population Chatacteristics 
       popc1 <- incomePRO(fips=fipsc,ctyname=placeName, ACS=oACS)
             print(popc1$plot)
 }
```

\FloatBarrier

```{r popOutC_educ, fig.width=6, fig.height=3.75, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
   if(outPopC){
      popc2 <- educPRO(fips=fipsc, ctyname=placeName, ACS=oACS)
      print(popc2$plot)
   }
```

\FloatBarrier
```{r popOutC_race1, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
   if(outPopC){
     race1 <- raceTab1(fips=fipsc,ctyname=placeName,ACS=oACS,oType="latex") 
      print(race1)
   }
```

```{r popOutC_race2, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
   if(outPopC){      
       race2 <- raceTab2(fips=fipsc,ctyname=placeName,ACS=oACS,oType="latex")
      print(race2)
       }
```

\newpage


`r if(outHouse) '## Housing and Households'`

`r if(outHouse) houseText(placeName)`

\FloatBarrier
```{r popHouse_housEst, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outHouse){
    # Housing
     poph1 <<- houseEstPRO(fips=fipsc,ctyname=placeName,curYr=oYr)
     print(poph1$plot)
 }
```

\FloatBarrier
```{r popHouse_housval, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outHouse){
    # Housing
     pophval <<- HouseVal(fips=fipsc,ctyname=placeName,ACS=oACS,oType="latex")
     print(pophval)
 }
```

\FloatBarrier
```{r popHouse_hcomp, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outHouse){
     hTab <- housePRO(fips=fipsc, ctyname=placeName, ACS=oACS, oType="latex")
     print(hTab)
 }
```

\FloatBarrier
```{r popHouse_OO, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outHouse){
     OOTab <- OOHouse(fips=fipsc,ctyname=placeName,ACS=oACS, oType="latex")
     print(OOTab)
 }
```

\FloatBarrier
```{r popHouse_RT, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outHouse){
     RTTab <- RTHouse(fips=fipsc,ctyname=placeName,ACS=oACS, oType="latex")
     print(RTTab)
        }
```

\newpage

`r if(outComm) '## Commuting'`

\FloatBarrier


```{r popComm_text, out.width=6, out.height=2, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
   if(outComm){
     cat("Commuting plays an important role in the economy of an area because not all workers live where they work. Commuting impacts local job growth, access to employees, and transportation infrastructure.")
   }

```


```{r popComm_venn, fig.width=6, fig.height=6,  warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outComm){
    # Commuting 
     popt1 <<- GenerateVenn(fips=fipsc,level=level, ctyname=placeName,oType="latex")
     grid.arrange(popt1$plot)
 }
```


\FloatBarrier

```{r popComm_Work, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
     if(outComm){
       print(popt1$workTab)
     }
```

```{r popComm_Live, out.width=6, out.height=6, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
    if(outComm){
      print(popt1$liveTab)
      }
```

\FloatBarrier
```{r popComm_jMig, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outComm){ 
      popt2 <<- jobMigration(fips=fipsc,ctyname=placeName,maxyr = oYr)
      print(popt2$plot)
       }
```

\newpage

`r if(outEmply) '## Employment by Industry'`

`r if(outEmply) 'State Demography Office Total Estimated Jobs time series and the current share of employment by industry are shown below.  Total estimated jobs are comprehensive in scope and include both wage & salary workers and proprietors.'`

\FloatBarrier

```{r outEmply_msjobs, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmply) {
       popei1 <<- ProfileDashboard::ms_jobs(fips=fipsc,ctyname=placeName, maxyr = oYr)
       print(popei1$plot)
 }
```

\FloatBarrier

```{r outEmply_jind, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmply) {
       popei2 <<- jobsByIndustry(fips=fipsc,ctyname=placeName, curyr = oYr)
       print(popei2$plot)
 }
```

\FloatBarrier

```{r outEmply_base,  fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmply) {
       popei3 <<- baseIndustries(fips=fipsc,ctyname=placeName, curyr = oYr, oType="latex")
       print(popei3$plot)
 }
```


```{r outEmply_base2, out.width=6, out.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmply) {
       print(popei3$table)
 }
```

\newpage

`r if(outEmplind) '## Employment and Demographic Forecast'`


`r if(outEmplind) 'Population and employment forecasts are presented below.  Rapid growth in the 65 and older age group will lead to more population growth than employment growth through 2040'`

\FloatBarrier

```{r outEmplind_jobsPop, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmplind) {
   #Employment and Demographic Forecast Materials
       popem1 <<- jobsPopForecast(fips=fipsc,ctyname=placeName)
       print(popem1$plot)
 }
```

\FloatBarrier

```{r outEmplind_wages, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmplind) {
      popem2 <<- weeklyWages(fips=fipsc,ctyname=placeName)
      print(popem2$plot)
 }
```

\FloatBarrier

```{r outEmplind_resLF1, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmplind) {
       popem3 <<- residentialLF(fips=fipsc,ctyname=placeName)
       print(popem3$plot1)
 }
```

\FloatBarrier

```{r outEmplind_resLF2, fig.width=6, fig.height=4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}
 if(outEmplind) {
       print(popem3$plot2)
 }
```
